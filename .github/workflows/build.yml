# Copyright (c) eBPF for Windows contributors
# SPDX-License-Identifier: MIT
---
name: CPP CI

on:
  push:
    branches: [ main, 'release/*' ]
  pull_request:

concurrency:
  # Cancel any CI/CD workflow currently in progress for the same PR.
  # Allow running concurrently with any other commits.
  group: build-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build_windows:
    permissions:
      actions: write  # for fkirc/skip-duplicate-actions to skip or stop workflow runs
      contents: write  # allow pushing release branches using GITHUB_TOKEN
    strategy:
      matrix:
        configurations: [Debug, Release]
    runs-on: windows-latest
    env:
      # Configuration type to build.  For documentation on how build matrices work, see
      # https://docs.github.com/actions/learn-github-actions/managing-complex-workflows#using-a-build-matrix
      BUILD_CONFIGURATION: ${{matrix.configurations}}
      BUILD_PLATFORM: x64
      SOLUTION_FILE: sample_program/sample_program.sln

    steps:
      - name: Cache Chocolatey packages
        if: steps.skip_check.outputs.should_skip != 'true'
        uses: actions/cache@v4
        with:
          path: "C:\\ProgramData\\chocolatey"
          key: ${{ runner.os }}-choco-${{ hashFiles('**/wdk.props') }}

      - name: Install LLVM 18.1.8
        run: |
          # Install LLVM 18.1.8 to ensure consistent version across runners
          try {
            choco install llvm --version=18.1.8 --allow-downgrade -y --force
            # Add installed LLVM to PATH first so it takes precedence
            echo "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            Write-Host "Successfully installed LLVM 18.1.8"
          } catch {
            Write-Warning "Failed to install LLVM 18.1.8 via chocolatey: $($_.Exception.Message)"
            Write-Host "Continuing with pre-installed LLVM version"
          }

      - name: Verify LLVM clang existence
        run: |
          $clangPath = "$env:ProgramFiles\LLVM\bin\clang.exe"
          Write-Host "Checking path: $clangPath"
          if (Test-Path $clangPath) {
            Write-Host "Found: $clangPath"
          } else {
            Write-Host "Not found: $clangPath"
          }

      - name: Print MSBuild architecture
        run: |
          [Environment]::Is64BitProcess

      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0
        with:
          submodules: 'recursive'

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@becb80cf9a036187bb1e07e74eb64e25850d757a

      - name: Cache nuget packages
        uses: actions/cache@v4
        env:
          cache-name: cache-nuget-modules
        with:
          path: |
            ${{ env.USERPROFILE }}\.nuget\packages
            ~/.nuget/packages
          key: ${{ runner.os }}-${{env.BUILD_PLATFORM}}-${{env.BUILD_CONFIGURATION}}-${{ hashFiles('**/wdk.props') }}
          restore-keys: |
            ${{ runner.os }}-${{env.BUILD_PLATFORM}}-${{env.BUILD_CONFIGURATION}}-
            ${{ runner.os }}-${{env.BUILD_PLATFORM}}-

      - name: Restore NuGet packages
        working-directory: ${{env.GITHUB_WORKSPACE}}
        run: |
          msbuild /t:Restore /p:Configuration=${{env.BUILD_CONFIGURATION}} /p:Platform=${{env.BUILD_PLATFORM}} ${{env.SOLUTION_FILE}}

      - name: Export program info
        working-directory: ${{env.GITHUB_WORKSPACE}}
        run: |
          # Find the installed ebpf-for-Windows.x64 package folder and call export_program_info.exe
          $pkg = Get-ChildItem -Path "$env:USERPROFILE\.nuget\packages\ebpf-for-Windows.x64\*" -Directory | Sort-Object Name -Descending | Select-Object -First 1
          if (-not $pkg) { Write-Host "ebpf-for-Windows.x64 package not found"; exit 0 }
          $exe = Join-Path $pkg.FullName 'build\native\bin\export_program_info.exe'
          if (-not (Test-Path $exe)) { Write-Host "export_program_info.exe not found at $exe"; exit 0 }
          & $exe --clear
          & $exe

      - name: Build
        working-directory: ${{env.GITHUB_WORKSPACE}}
        run: |
          msbuild /m /p:Configuration=${{env.BUILD_CONFIGURATION}} /p:Platform=${{env.BUILD_PLATFORM}} ${{env.SOLUTION_FILE}}

      - name: Publish release binaries
        if: startsWith(github.ref, 'refs/heads/release/') && matrix.configurations == 'Release'
        working-directory: ${{env.GITHUB_WORKSPACE}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "Running publish_release_binaries.ps1"
          powershell -ExecutionPolicy Bypass -File .\scripts\publish_release_binaries.ps1
